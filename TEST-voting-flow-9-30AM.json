{
  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "$connections": {
      "defaultValue": {},
      "type": "Object"
    }
  },
  "triggers": {
    "Recurrence": {
      "recurrence": {
        "frequency": "Day",
        "interval": 1,
        "schedule": {
          "hours": ["9"],
          "minutes": [30]
        },
        "timeZone": "Eastern Standard Time"
      },
      "type": "Recurrence",
      "metadata": {
        "description": "‚ö° IMMEDIATE TEST: Set to 9:30 AM today. Change to Thursday 12:00 PM for production."
      }
    }
  },
  "actions": {
    "Initialize_Test_Restaurants": {
      "runAfter": {},
      "type": "InitializeVariable",
      "inputs": {
        "variables": [
          {
            "name": "TestRestaurants",
            "type": "Array",
            "value": [
              {"RestaurantName": "Pizza Palace"},
              {"RestaurantName": "Burger Barn"}, 
              {"RestaurantName": "Taco Town"},
              {"RestaurantName": "Sandwich Shop"}
            ]
          }
        ]
      }
    },
    "Send_Test_Voting_Email": {
      "runAfter": {
        "Initialize_Test_Restaurants": ["Succeeded"]
      },
      "type": "ApiConnection",
      "inputs": {
        "host": {
          "connection": {
            "name": "@parameters('$connections')['office365']['connectionId']"
          }
        },
        "method": "post",
        "path": "/v2/Mail",
        "body": {
          "To": "pacheco@oemeta.com",
          "Subject": "üó≥Ô∏è TEST: Weekly Lunch Voting is Open!",
          "Body": "<h2>üß™ TESTING MODE - Only You Will Receive This</h2><h3>Weekly Lunch Voting</h3><p>It's time to vote for this week's lunch restaurant! üçï</p><p><strong>Voting closes in 15 minutes (9:45 AM)</strong></p><h3>Restaurant Options:</h3><ul><li><strong>Pizza Palace</strong></li><li><strong>Burger Barn</strong></li><li><strong>Taco Town</strong></li><li><strong>Sandwich Shop</strong></li></ul><div style=\"text-align: center; margin: 20px 0;\"><a href=\"https://forms.office.com/e/dH0SR0c1Gj\" style=\"background-color: #0078d4; color: white; padding: 15px 25px; text-decoration: none; border-radius: 5px; font-size: 16px; display: inline-block;\">üó≥Ô∏è VOTE NOW</a></div><p><strong>Don't forget to vote!</strong> Testing the system.</p><p><em>üîß This is a test email. Only you are receiving this.</em></p>",
          "IsHtml": true,
          "Importance": "High"
        }
      }
    },
    "Create_Test_Vote_Entry": {
      "runAfter": {
        "Send_Test_Voting_Email": ["Succeeded"]
      },
      "type": "ApiConnection",
      "inputs": {
        "host": {
          "connection": {
            "name": "@parameters('$connections')['sharepointonline']['connectionId']"
          }
        },
        "method": "post",
        "path": "/datasets/@{encodeURIComponent(encodeURIComponent('https://oemeta01.sharepoint.com/sites/OemetaNorthAmerica'))}/tables/@{encodeURIComponent(encodeURIComponent('Weekly_Votes'))}/items",
        "body": {
          "Title": "TEST VOTING STARTED",
          "VoterName": "SYSTEM_TEST",
          "RestaurantChoice": "VOTING_STARTED",
          "VoteDate": "@utcnow()",
          "WeekNumber": "@div(sub(ticks(utcnow()), ticks('1970-01-01T00:00:00Z')), 604800000)"
        }
      }
    }
  }
}
